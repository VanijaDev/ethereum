<!doctype html>
<html>
    <head>
        <title>My Number contract</title>
        <script src="dist/web3.min.js"></script>
        <script type="text/javascript">
            if (typeof web3 !== 'undefined') {
                web3 = new Web3(web3.currentProvider);
            } else {
                // set the provider you want from Web3.providers
                web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
            }
            
            //  get balance
            function getBalance() {
                web3.eth.getBalance(web3.eth.accounts[0], function(error, result) {
                    if (error) {
                        console.log("Error while getting balance: " + error);
                    } else {
                        document.getElementById("myBalance").innerText = web3.fromWei(result, "ether");
                    }
                });
            }

            // Number Contract
            var numberContractAddress = "0xB0Bd03Ef6D6cD99C3d7BA234F78B0020cc2D2fE4";
            var numberContractABI = [ { "constant": true, "inputs": [], "name": "getCreator", "outputs": [ { "name": "", "type": "address", "value": "0x28396f2f3d9ed9565a9dedfc3aab98161f7b0622" } ], "payable": false, "type": "function" }, { "constant": false, "inputs": [], "name": "kill", "outputs": [], "payable": false, "type": "function" }, { "constant": false, "inputs": [ { "name": "myNewNumber", "type": "uint256" } ], "name": "setMyNumber", "outputs": [], "payable": false, "type": "function" }, { "constant": true, "inputs": [], "name": "getMyNumber", "outputs": [ { "name": "", "type": "uint256", "value": "3" } ], "payable": false, "type": "function" }, { "inputs": [], "payable": false, "type": "constructor" } ];
            var numberContractInst = web3.eth.contract(numberContractABI).at(numberContractAddress);

            ///***************  get counter **********//
            function updateCounter() {
                getCounterNumber()
                .then(num => document.getElementById("myCounter").innerText = num);
            }
            
            async function getCounterNumber() {
                return new Promise((number, error) => {
                    numberContractInst.getMyNumber(function(error, value) {
                        if(error) {
                            console.error("Error while getting number: " + error);
                            error(error);
                        } else {
                            number(value.toNumber());
                        }
                    });
                });
            }
            ///***************  get counter **********//


            ///***************  increase counter **********//
            function increaseCounter() {
                getCounterNumber()
                .then(num => {
                    var acc = web3.eth.accounts[0];
                    var pass = 'Test1234';

                    unlockAccount(acc, pass)
                    .then(success => {
                        if(!success) {
                            return;
                        }

                        var newNum = num + 1;
                        numberContractInst.setMyNumber(newNum, {from:acc, gas: 200000}, function(err, result) {
                            if(err) {
                                console.error(err);
                                return;
                            }
                            
                            var txHash = result;
                            console.log("Successful transaction: " + txHash);
                            callWhenMined(txHash, updateCounter);
                        });
                    });
                });
            };
            ///***************  increase counter **********//


            ///***************  helpers **********//
            async function unlockAccount(address, password) {
                return new Promise((success) => {
                    web3.personal.unlockAccount(address, password, function(unlockError, unlockSuccess) {
                        if(unlockError) {
                            console.error(unlockError);
                        } 
                        success(unlockSuccess);
                    });
                });
            }

            function callWhenMined(txHash, callback) {
                web3.eth.getTransactionReceipt(txHash, function(err, rcpt) {
                    if(err) {
                        console.error(err);
                        return;
                    }

                    if(rcpt) {
                        callback();
                    } else {
                        setTimeout(function() {
                            callWhenMined(txHash, callback);
                        }, 500);
                    }
                });
            }

        </script>
    </head>
    <body>
        <h1>Counter</h1>
        <div>
            <button onclick="getBalance()">Get balance</button>
            <span id="myBalance">...</span>
        </div>

        <div style="margin-top: 20px">
            <button onclick="updateCounter()">Update counter</button>
            <button onclick="increaseCounter()">Increase counter</button>
            number is <span id="myCounter">...</span>.
        </div>
    </body>
</html>